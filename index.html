<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∞—Ö–º–∞—Ç–Ω—ã–π –±–æ—Ç Stockfish</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #board {
            width: 480px;
            height: 480px;
            margin: 20px auto;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        button {
            padding: 12px 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button#undoBtn {
            background: #ff9800;
        }
        button#hintBtn {
            background: #2196F3;
        }
        .status {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin: 20px;
            min-height: 40px;
            color: #333;
        }
        .difficulty {
            text-align: center;
            margin: 20px 0;
        }
        select {
            padding: 8px;
            font-size: 16px;
            border-radius: 5px;
            margin-left: 10px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ôõ –®–∞—Ö–º–∞—Ç–Ω—ã–π –±–æ—Ç —Å Stockfish ‚ôö</h1>
        
        <div class="difficulty">
            <label for="level">–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:</label>
            <select id="level">
                <option value="1">–ù–æ–≤–∏—á–æ–∫ (—É—Ä–æ–≤–µ–Ω—å 1)</option>
                <option value="5" selected>–õ—é–±–∏—Ç–µ–ª—å (—É—Ä–æ–≤–µ–Ω—å 5)</option>
                <option value="10">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π (—É—Ä–æ–≤–µ–Ω—å 10)</option>
                <option value="15">–≠–∫—Å–ø–µ—Ä—Ç (—É—Ä–æ–≤–µ–Ω—å 15)</option>
                <option value="20">–ì—Ä–æ—Å—Å–º–µ–π—Å—Ç–µ—Ä (—É—Ä–æ–≤–µ–Ω—å 20)</option>
            </select>
        </div>
        
        <div id="board"></div>
        
        <div class="status" id="status">–í–∞—à —Ö–æ–¥. –í—ã –∏–≥—Ä–∞–µ—Ç–µ –±–µ–ª—ã–º–∏.</div>
        
        <div class="controls">
            <button id="newGameBtn">–ù–æ–≤–∞—è –∏–≥—Ä–∞ ‚ôªÔ∏è</button>
            <button id="undoBtn">–û—Ç–º–µ–Ω–∏—Ç—å —Ö–æ–¥ ‚Ü©Ô∏è</button>
            <button id="hintBtn">–ü–æ–¥—Å–∫–∞–∑–∫–∞ üí°</button>
            <button id="flipBtn">–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –¥–æ—Å–∫—É üîÑ</button>
        </div>
        
        <div id="moveHistory" style="margin-top: 20px; text-align: center;"></div>
    </div>

    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://unpkg.com/chess.js@0.13.4/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <!-- Stockfish.js - —à–∞—Ö–º–∞—Ç–Ω—ã–π –¥–≤–∏–∂–æ–∫ -->
    <script src="https://unpkg.com/stockfish.js@11.0.0/stockfish.js"></script>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const chess = new Chess();
        let board = null;
        let gameOver = false;
        let stockfish = null;
        let difficulty = 5; // –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (1-20)
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Stockfish
        function initStockfish() {
            stockfish = new Worker('https://unpkg.com/stockfish.js@11.0.0/stockfish.js');
            
            stockfish.onmessage = function(event) {
                const message = event.data;
                
                if (message.startsWith('bestmove')) {
                    const move = message.split(' ')[1];
                    if (move && move !== '(none)') {
                        makeStockfishMove(move);
                    }
                }
            };
            
            setDifficulty(difficulty);
        }
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ä–æ–≤–Ω—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        function setDifficulty(level) {
            difficulty = parseInt(level);
            if (stockfish) {
                stockfish.postMessage('setoption name Skill Level value ' + difficulty);
            }
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å–∫–∏
        function initBoard() {
            const config = {
                draggable: true,
                position: 'start',
                orientation: 'white',
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd
            };
            board = Chessboard('board', config);
            updateStatus();
            initStockfish();
        }
        
        // –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Ñ–∏–≥—É—Ä—ã
        function onDragStart(source, piece) {
            if (gameOver) return false;
            if (chess.turn() === 'w' && piece.search(/^b/) !== -1) return false;
            if (chess.turn() === 'b' && piece.search(/^w/) !== -1) return false;
        }
        
        // –ö–æ–≥–¥–∞ —Ñ–∏–≥—É—Ä–∞ –±—Ä–æ—à–µ–Ω–∞
        function onDrop(source, target) {
            if (gameOver) return 'snapback';
            
            const move = chess.move({
                from: source,
                to: target,
                promotion: 'q'
            });
            
            if (move === null) return 'snapback';
            
            updateStatus();
            updateMoveHistory();
            
            // –•–æ–¥ Stockfish
            if (!chess.game_over()) {
                setTimeout(() => {
                    getStockfishMove();
                }, 300);
            }
        }
        
        // –ü–æ–ª—É—á–∏—Ç—å —Ö–æ–¥ –æ—Ç Stockfish
        function getStockfishMove() {
            if (!stockfish || gameOver) return;
            
            stockfish.postMessage('position fen ' + chess.fen());
            stockfish.postMessage('go depth 12');
        }
        
        // –°–¥–µ–ª–∞—Ç—å —Ö–æ–¥ Stockfish
        function makeStockfishMove(moveString) {
            if (gameOver) return;
            
            const move = chess.move(moveString);
            if (move) {
                board.position(chess.fen());
                updateStatus();
                updateMoveHistory();
            }
        }
        
        // –ü–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        function onSnapEnd() {
            board.position(chess.fen());
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus() {
            let status = '';
            let color = chess.turn() === 'w' ? '#2196F3' : '#f44336';
            
            if (chess.turn() === 'w') {
                status = '–í–∞—à —Ö–æ–¥ (–±–µ–ª—ã–µ)';
            } else {
                status = '–ë–æ—Ç –¥—É–º–∞–µ—Ç...';
            }
            
            if (chess.in_check()) {
                status += ' - –®–ê–•!';
            }
            
            if (chess.game_over()) {
                gameOver = true;
                if (chess.in_checkmate()) {
                    status = '–®–ê–• –ò –ú–ê–¢! ' + 
                           (chess.turn() === 'w' ? '–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏!' : '–í—ã –ø–æ–±–µ–¥–∏–ª–∏!');
                } else if (chess.in_draw()) {
                    status = '–ù–ò–ß–¨–Ø!';
                } else if (chess.in_stalemate()) {
                    status = '–ü–ê–¢!';
                } else if (chess.in_threefold_repetition()) {
                    status = '–ù–ò–ß–¨–Ø (—Ç—Ä–æ–µ–∫—Ä–∞—Ç–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ)';
                }
            }
            
            document.getElementById('status').innerHTML = status;
            document.getElementById('status').style.color = color;
        }
        
        // –ò—Å—Ç–æ—Ä–∏—è —Ö–æ–¥–æ–≤
        function updateMoveHistory() {
            const moves = chess.history();
            const moveList = document.getElementById('moveHistory');
            let html = '<strong>–ò—Å—Ç–æ—Ä–∏—è —Ö–æ–¥–æ–≤:</strong><br>';
            
            for (let i = 0; i < moves.length; i += 2) {
                const moveNumber = Math.floor(i / 2) + 1;
                const whiteMove = moves[i] || '';
                const blackMove = moves[i + 1] || '';
                html += `${moveNumber}. ${whiteMove} ${blackMove}<br>`;
            }
            
            moveList.innerHTML = html;
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('newGameBtn').addEventListener('click', () => {
            chess.reset();
            gameOver = false;
            board.position(chess.fen());
            board.orientation('white');
            updateStatus();
            updateMoveHistory();
            document.getElementById('moveHistory').innerHTML = '';
        });
        
        document.getElementById('undoBtn').addEventListener('click', () => {
            chess.undo();
            chess.undo();
            board.position(chess.fen());
            gameOver = false;
            updateStatus();
            updateMoveHistory();
        });
        
        document.getElementById('hintBtn').addEventListener('click', () => {
            if (chess.turn() !== 'w' || chess.game_over()) return;
            
            // –ó–∞–ø—Ä–æ—Å –ø–æ–¥—Å–∫–∞–∑–∫–∏ —É Stockfish
            stockfish.postMessage('position fen ' + chess.fen());
            stockfish.postMessage('go depth 10');
            
            const originalHandler = stockfish.onmessage;
            stockfish.onmessage = function(event) {
                const message = event.data;
                if (message.startsWith('bestmove')) {
                    const move = message.split(' ')[1];
                    if (move && move !== '(none)') {
                        alert('–ü–æ–¥—Å–∫–∞–∑–∫–∞: ' + move);
                    }
                    stockfish.onmessage = originalHandler;
                }
            };
        });
        
        document.getElementById('flipBtn').addEventListener('click', () => {
            board.flip();
        });
        
        document.getElementById('level').addEventListener('change', (e) => {
            setDifficulty(e.target.value);
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        $(document).ready(initBoard);
    </script>
</body>
</html>